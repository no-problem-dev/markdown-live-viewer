---
name: spec09-get-to-work
description: タスク仕様書から未実装タスクを自動的に選択し、ブランチ作成・実装・PRまでを一貫して実行する
---

# Authority

あなたは**プライマリーエージェント（オーケストレーター）**として振る舞う。
実際のタスク実装は**サブエージェント（sonnet model）**に委譲し、自身は全体の計画・監視・進捗管理に専念する。

## エージェントアーキテクチャ

```
┌─────────────────────────────────────────────────────────┐
│  プライマリーエージェント（あなた・Orchestrator）        │
│  - タスク計画・依存関係分析                              │
│  - 並列実行グループの決定                                │
│  - サブエージェントの起動・監視                          │
│  - 進捗管理・完了判定                                    │
└─────────────────────────────────────────────────────────┘
              │                    │                    │
              ▼                    ▼                    ▼
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│ サブエージェント │  │ サブエージェント │  │ サブエージェント │
│ (sonnet model)  │  │ (sonnet model)  │  │ (sonnet model)  │
│ Task: T01       │  │ Task: T02       │  │ Task: T03       │
│ 並列実行グループ1 │  │ 並列実行グループ1 │  │ 並列実行グループ1 │
└─────────────────┘  └─────────────────┘  └─────────────────┘
```

## プライマリーエージェントの自律レベル

| 行動 | レベル | 備考 |
|------|--------|------|
| 仕様書の読み込み（Serena MCP使用） | Level 4（自律） | セマンティックに把握 |
| 完了タスクの確認 | Level 4（自律） | |
| 未実装タスクの抽出 | Level 4（自律） | |
| 依存関係グラフ構築 | Level 4（自律） | |
| コンフリクト分析 | Level 4（自律） | |
| 並列実行グループ決定 | Level 4（自律） | |
| サブエージェント並列起動 | Level 4（自律） | Task tool使用 |
| サブエージェント監視 | Level 4（自律） | 完了待ち・エラーハンドリング |
| 進捗更新 | Level 4（自律） | 全タスク完了後 |
| compact実行 | Level 4（自律） | グループ完了時に必須実行 |
| 次グループ実行判定 | Level 4（自律） | 依存解消チェック |

## サブエージェントの責務

| 行動 | 備考 |
|------|------|
| ブランチ作成 | 命名規則に従う |
| タスク実装 | verificationをすべてクリア |
| コミット・プッシュ | |
| PR作成 | フォーマットに従う |
| セルフレビュー | gh pr diffで確認 |
| PR自動マージ | 直接マージ（approve不要） |

## 禁止事項（全エージェント共通）

| 行動 | レベル | 備考 |
|------|--------|------|
| `main`への直接PR | Level 0（禁止） | 必ず`develop`へ |
| verification未クリアでのPR | Level 0（禁止） | |
| 依存タスク未完了での着手 | Level 0（禁止） | |

## エスカレーション条件

以下の場合はユーザーに確認する：
- サブエージェントが仕様との矛盾を報告
- サブエージェントがverificationをクリアできないと報告
- マージコンフリクトが自動解決不可
- 複数のサブエージェントが同時に失敗

## 判断に迷った場合

- 仕様書（spec/sdd/）を再確認
- 依存関係を厳守
- 失敗したサブエージェントのタスクは次グループで再試行

---

# Target

## 価値仮説

タスク仕様書に基づき機械的にタスクを消化する必要がある。
この実行管理により、セルフレビュー・マージまでを一貫して自動実行し、開発サイクルを高速化する。

## 対象者

- **開発チーム**: タスクを機械的に消化し、マージまで自動化したい
- **プロジェクト管理**: 依存関係を考慮した効率的なタスク消化を望む

## 出力への示唆

- 1タスク = 1ブランチ = 1PR = 1マージ
- verification全項目クリア
- 進捗更新を忘れない
- 依存関係のないタスクは並列実行

---

# Limit

## 禁止

### プライマリーエージェント（あなた）の禁止事項
- 依存タスク未完了のタスクを並列グループに含める
- 影響ファイルが重複するタスクを同一グループに含める
- サブエージェントの完了を待たずに次グループを起動
- 進捗更新（06_implementation_log/）の記録漏れ
- 自分でタスク実装を行う（サブエージェントに委譲すること）

### サブエージェントの禁止事項（プロンプトに含める）
- `main` ブランチへの直接PR
- `verification` 未クリアでのPR作成・マージ
- タスク範囲外の「ついでの修正」
- 他のブランチへの切り替え（自分のタスクのブランチのみ操作）

## 避ける

- サブエージェントへの曖昧な指示
- 過度に多くのサブエージェントの同時起動（推奨: 3-5個まで）
- 仕様書の確認なしでのサブエージェント起動

---

# Action

## タスク

`spec/sdd/05_tasks/` にある未実装タスクを、サブエージェントを並列起動して効率的に実装する。

## プライマリーエージェント（あなた）の手順

### Phase 1: 計画フェーズ

1. **仕様書の把握**
   - Serena MCPを用いてセマンティックに仕様書（`@spec/sdd/` 配下）を把握
   - サブエージェントへの指示に必要な情報を収集

2. **進捗確認**
   - `spec/sdd/06_implementation_log/01_completed_tasks.md` と `04_statistics.md` を読み、完了済みタスクを確認
   - 各Phaseファイルから未実装タスクを抽出

3. **依存関係グラフ構築**
   - 全タスクの `deps` フィールドから依存関係グラフを構築
   - 依存タスクが未完了のタスクは実行不可とマーク
   - 循環依存がないことを確認

4. **コンフリクト分析**
   - 選定候補タスクの `description` から影響ファイルを特定
   - 他の未実装タスクと影響ファイルが重複する場合、コンフリクトリスクありと判定

5. **並列実行グループ決定**
   - **並列実行可能条件**：
     - 依存タスクがすべて完了済み AND
     - 影響ファイルが他の実行可能タスクと重複しない
   - 条件を満たすタスクを**並列実行グループ**としてまとめる
   - Phase順 → T番号順で優先度付け

### Phase 2: サブエージェント並列起動フェーズ

**重要**: Task toolを使用し、**単一メッセージで複数のサブエージェントを同時起動**する。

```
# 並列実行グループ内の全タスクを同時に起動する例
Task tool呼び出し1: T01実装サブエージェント (model: sonnet)
Task tool呼び出し2: T02実装サブエージェント (model: sonnet)
Task tool呼び出し3: T03実装サブエージェント (model: sonnet)
↑ これらを単一メッセージで同時に送信
```

各サブエージェントへのプロンプトには以下を含める：
- タスク番号・タスク名
- タスクの `description` 全文
- `spec_refs` で参照すべき仕様書パス
- `verification` の全項目
- ブランチ命名規則
- PR作成・セルフレビュー・マージまでの手順

**サブエージェント起動プロンプトテンプレート**:
```
あなたは実装サブエージェントです。以下のタスクを完遂してください。

## タスク情報
- タスク番号: T[番号]
- タスク名: [タスク名]
- Phase: [Phase番号]

## 実装内容
[description全文]

## 参照仕様書
[spec_refs一覧]

## 検証項目（全項目クリア必須）
[verification一覧]

## 実行手順
1. developから新規ブランチ作成: [ブランチ名]
2. タスク実装
3. verification全項目クリア確認
4. コミット: `feat: T[番号] [タスク名]`
5. PR作成（develop向け）
6. セルフレビュー（gh pr diff）
7. マージ（gh pr merge --squash --delete-branch）
8. 完了報告（PR URL、verification結果）

## ブランチ名
[prefix]/t[番号]-[kebab-case-task-name]

## 禁止事項
- mainへの直接PR
- verification未クリアでのPR作成
- タスク範囲外の修正
```

### Phase 3: 監視・待機フェーズ

1. **サブエージェント完了待ち**
   - 全サブエージェントの完了を待機
   - 各サブエージェントからの完了報告を収集

2. **結果確認**
   - 成功したタスク一覧
   - 失敗したタスク（あれば理由を確認）
   - マージされたPR URL一覧

3. **エラーハンドリング**
   - サブエージェントが失敗した場合、原因を分析
   - 再試行可能なら次グループで再試行
   - ユーザー確認が必要ならエスカレーション

### Phase 4: 進捗更新・compact・次グループ実行フェーズ

1. **進捗更新**
   - `spec/sdd/06_implementation_log/01_completed_tasks.md` に完了タスク情報を一括記録
   - `spec/sdd/06_implementation_log/04_statistics.md` の進捗を更新

2. **🔄 compact実行（必須）**
   - **タイミング**: 並列実行グループの全タスク完了後、次グループ起動前
   - **目的**: コンテキストウィンドウの効率的な使用、長時間セッションの安定性確保
   - **実行方法**: `/compact` コマンドを実行
   - **compact後の状態確認**:
     - 完了済みグループの情報が要約されていること
     - 次グループの実行に必要な情報が保持されていること
     - 依存関係グラフの状態が維持されていること

3. **依存解消チェック**
   - マージ完了により新たに実行可能になったタスクを特定
   - 次の並列実行グループを構成

4. **継続判定**
   - 未実装タスクが残っている場合：Phase 2に戻り次グループを並列起動
   - 全タスク完了：完了報告

## Compact戦略

### なぜcompactが必要か

- 複数グループの並列実行は長時間セッションになりやすい
- サブエージェントの出力がコンテキストを圧迫する
- グループ完了時点で詳細な実行ログは不要になる

### compactのタイミング

```
グループ1実行 → グループ1完了 → 進捗更新 → 🔄 compact → グループ2実行 → ...
```

| イベント | compact実行 |
|---------|------------|
| グループ完了時 | ✅ 必須 |
| 全タスク完了時 | ✅ 必須（最終報告前） |
| エラー発生時 | ❌ 不要（デバッグ情報保持） |

### compact後に保持すべき情報

- [ ] 全体の進捗状況（完了タスク数/総タスク数）
- [ ] 完了済みタスクのPR URL一覧
- [ ] 失敗・再試行が必要なタスク一覧
- [ ] 次グループで実行予定のタスク一覧
- [ ] 依存関係グラフの現在状態

## サブエージェントの実行手順（参考）

サブエージェントは以下の手順を自律的に実行する：

1. **ブランチ作成**
   - `git checkout develop && git pull origin develop`
   - `git checkout -b [ブランチ名]`

2. **タスク実装**
   - `description` に従い実装
   - `spec_refs` の仕様書を確認

3. **検証**
   - `verification` の各項目を機械的にチェック
   - すべてチェックが通るまで実装を調整

4. **コミット・プッシュ**
   - `git add [対象ファイル]`
   - `git commit -m "feat: T[番号] [タスク名]"`
   - `git push -u origin [ブランチ名]`

5. **PR作成・マージ**
   - `gh pr create --base develop --title "feat: T[番号] [タスク名]" --body "[PR本文]"`
   - `gh pr diff [PR番号]` でセルフレビュー
   - `gh pr merge [PR番号] --squash --delete-branch`（approve不要で直接マージ）

6. **完了報告**
   - PR URL
   - verification結果
   - 実装サマリー

## ブランチ命名規則

| タスク種別 | ブランチプレフィックス | 例 |
|-----------|---------------------|-----|
| Create/Implement/Add | `feat/` | `feat/t01-initialize-vite-project` |
| Fix | `fix/` | `fix/t42-stripe-webhook-error` |
| ドキュメント作成 | `doc/` | `doc/t85-terms-of-service` |
| Verify/Test | `feat/` | `feat/t90-e2e-test-payment` |

ブランチ名形式：`[prefix]/t[番号]-[kebab-case-task-name]`（30文字以内、英語のみ）

## 出力形式

### 計画フェーズ完了時（サブエージェント起動前）

```markdown
## 並列実行計画

**仕様書の把握**: Serena MCPを用いてセマンティックに仕様書を把握済み

### 依存関係グラフ
[依存関係の可視化]

### 並列実行グループ

**グループ1**（現在実行）:
| タスク | Phase | 影響ファイル | ブランチ名 |
|--------|-------|-------------|-----------|
| T01: [タスク名] | Phase 1 | [ファイル一覧] | feat/t01-xxx |
| T02: [タスク名] | Phase 1 | [ファイル一覧] | feat/t02-xxx |
| T03: [タスク名] | Phase 1 | [ファイル一覧] | feat/t03-xxx |

**グループ2**（グループ1完了後）:
| タスク | Phase | 依存タスク | ブランチ名 |
|--------|-------|-----------|-----------|
| T04: [タスク名] | Phase 2 | T01 | feat/t04-xxx |

**サブエージェント起動**: [N]個のサブエージェント（sonnet）を並列起動します
```

### サブエージェント監視中

```markdown
## サブエージェント実行状況

| タスク | ステータス | PR URL | 備考 |
|--------|----------|--------|------|
| T01 | 🟢 完了・マージ済み | [URL] | |
| T02 | 🔄 実行中 | - | |
| T03 | 🔴 失敗 | - | [エラー内容] |
```

### グループ完了時

```markdown
## グループ1 完了報告

**完了タスク**: [N]個
| タスク | PR URL | マージ時刻 |
|--------|--------|----------|
| T01: [タスク名] | [URL] | [時刻] |
| T02: [タスク名] | [URL] | [時刻] |

**失敗タスク**: [M]個
| タスク | 原因 | 対応 |
|--------|------|------|
| T03: [タスク名] | [原因] | 次グループで再試行 |

**進捗更新**: 06_implementation_log/ を更新済み

---
🔄 **compact実行中...**
---

**compact完了**: コンテキストを圧縮しました

**保持情報の確認**:
- [x] 進捗状況: [完了数]/[総数] タスク完了
- [x] 完了PR一覧: [N]件
- [x] 失敗タスク: [M]件（再試行予定）
- [x] 次グループ: グループ2（[K]タスク）

**次のアクション**:
- 依存解消により実行可能になったタスク: [一覧]
- 次グループ（グループ2）を起動します
```

### 全タスク完了時

```markdown
## 全タスク完了報告

---
🔄 **最終compact実行中...**
---

**compact完了**: 最終レポート用にコンテキストを整理しました

**総タスク数**: [N]個
**成功**: [M]個
**失敗**: [K]個

### マージ済みPR一覧
| タスク | PR URL |
|--------|--------|
| T01 | [URL] |
| T02 | [URL] |
...

### 実行統計
- 並列実行グループ数: [G]グループ
- compact実行回数: [C]回
- 総実行時間: 計測不可（参考情報なし）

**進捗更新**: 06_implementation_log/ を最終更新済み
```

### PR本文フォーマット

```markdown
## Summary
- [タスク概要]

## Body
- [U:追加, M:修正, D:削除]: [ファイル名]
    - [変更内容]

## Verification
- [x] [検証項目1]
- [x] [検証項目2]

## Related
- Task: T[番号]
- Phase: [Phase番号]
```

---

# Signal

## 完了条件

### プライマリーエージェント（あなた）の完了条件
- [ ] 依存関係グラフを構築した
- [ ] 並列実行グループを決定した
- [ ] サブエージェントを並列起動した
- [ ] 全サブエージェントの完了を確認した
- [ ] 進捗更新（06_implementation_log/）を行った
- [ ] **グループ完了ごとにcompactを実行した**
- [ ] 未実装タスクがなくなるまで繰り返した
- [ ] **最終報告前にcompactを実行した**

### サブエージェントの完了条件（各タスクごと）
- [ ] 依存タスクがすべて完了している（`deps`チェック）
- [ ] 仕様書（spec_refs）を確認した
- [ ] verification全項目をクリアした
- [ ] 正しいブランチ命名規則に従った
- [ ] PRが`develop`に向けて作成された
- [ ] セルフレビューを実施した
- [ ] PRをマージしブランチを削除した

## 品質基準

| 観点 | 基準 |
|------|------|
| 依存関係 | deps記載のタスクがすべて完了済みのタスクのみ並列グループに含める |
| コンフリクト回避 | 影響ファイルが重複するタスクは同一グループに含めない |
| 仕様準拠 | spec_refsの仕様に従っている |
| 検証 | verification全項目PASS |
| コード品質 | TypeScript厳格モード、ESLint/Prettier準拠 |

## 異常シグナル

| シグナル | 条件 | プライマリーエージェントのアクション |
|---------|------|-----------|
| 🔴 STOP | 全サブエージェントが失敗 | ユーザーにエスカレーション |
| 🔴 STOP | 循環依存を検出 | ユーザーに報告、タスク定義の修正を依頼 |
| 🟡 WARN | 一部サブエージェントが失敗 | 失敗タスクを次グループで再試行 |
| 🟡 WARN | 影響ファイル重複あり | 該当タスクを別グループに分離 |
| 🔵 INFO | サブエージェントが仕様矛盾を報告 | ユーザーに確認後、指示を更新して再試行 |
| 🟢 GO | 依存なし・重複なし | 並列実行グループに追加 |
| 🟢 PASS | グループ内全タスク成功 | 進捗更新 → **compact** → 次グループへ |
| 🟢 DONE | 全タスク完了 | **compact** → 最終報告 |
